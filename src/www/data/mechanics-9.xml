<?xml version="1.0" encoding="utf-8"?>

<mechanics book="9">

    <!-- LIST OF TRANSLATED IMAGES -->
    <translated-images>
        <image>weapons.png</image>
    </translated-images>

    <!-- GAME RULES -->
    <sections>

        <section id="tssf">
            <!-- Restore the endurance to the maximum -->
            <endurance count="+[MAXENDURANCE]" />
            <!-- Drop the previous books map -->
            <drop objectId="map" />
            <!-- Drop the Paido sword. It was not really a game object -->
            <drop objectId="paidosword" />
        </section>

        <section id="gamerulz">
            <!-- Select the player skills (weapons skill and endurance) UI -->
            <setSkills />
        </section>

        <section id="discplnz">
            <!-- Select the Kai disciplines UI -->
            <setDisciplines />
        </section>
        
        <section id="equipmnt" pickMaximum="5">
            <!-- Do not pick 2 maps! -->
            <test not="true" hasObject="map" >
                <pick objectId="map" />
            </test>
            <test not="true" hasObject="backpack" >
                <pick objectId="backpack" />
            </test>

            <randomTable>
                <pick class="money" count="[RANDOM] + 10" />
            </randomTable>

            <!-- Kai monastery safekeeping -->
            <kaiMonasteryStorage />

            <object objectId="sword" />
            <object objectId="bow" />
            <object objectId="quiver" count="6" />
            <object objectId="rope" />
            <object objectId="laumspurpotion4" />
            <object objectId="lantern" />
            <object objectId="mace" />
            <object objectId="meal" index="0" />
            <object objectId="meal" index="1" />
            <object objectId="meal" index="2" />
            <object objectId="dagger" />
            <object objectId="fireseed" index="0" />
            <object objectId="fireseed" index="1" />
            <object objectId="fireseed" index="2" />

            <chooseEquipment
                en-text="Click on the Random Table link to get money before continue" 
                es-text="Haz click en el link de la Tabla de la Suerte para obtener dinero antes de continuar"
            />

            <message
                en-text="You may take up to five of the following (all meals and fireseeds count as one object):" 
                es-text="Puedes elegir hasta cinco de los objetos (todas las comidas y petardos cuentan como un objeto):" 
            />
        </section>

        <section id="sect3">
            <choiceState section="all" set="disabled" />
            <afterCombats>
                <test not="true" expression="[COMBATSDURATION] >= 3">
                    <choiceState section="sect117" set="enabled" />
                </test>
                <test expression="[COMBATSDURATION] >= 3">
                    <choiceState section="sect276" set="enabled" />
                </test>
            </afterCombats>
        </section>

        <section id="sect4">
            <death />
        </section>

        <section id="sect5" pickMaximum="2">
            <object objectId="silverbowl" />
            <object objectId="vialgolddust" />
            <object objectId="altarcloth" />
            <object objectId="scrollhonour" />
            <object objectId="jadinanklets" />
        </section>

        <section id="sect7">
            <drop objectId="largerope|rope" />
        </section>

        <section id="sect8">
            <choiceState section="all" set="disabled" />
            <test hasDiscipline="hntmstry">
                <choiceState section="sect36" set="enabled" />
            </test>
            <test not="true" hasDiscipline="hntmstry">
                <randomTable>
                    <case from="0" to="3">
                        <choiceState section="sect119" set="enabled" />
                    </case>
                    <case from="4" to="99">
                        <choiceState section="sect260" set="enabled" />
                    </case>
                </randomTable>
            </test>
        </section>

        <section id="sect9">
            <!-- TODO: Drop arrow? -->
        </section>

        <section id="sect10">
            <choiceState section="all" set="disabled" />
            <combat noMindblast="true" noPsiSurge="true" />
            <afterCombats>
                <choiceState section="all" set="enabled" />
            </afterCombats>
        </section>

        <section id="sect11">
            <meal index="0" />
            <meal index="1" />
            <test canUseBow="false">
                <!-- TODO: Drop arrow? -->
                <choiceState section="sect171" set="disabled" />
            </test>
        </section>

        <section id="sect12">
            <pick class="arrow" count="-1" />
            <test canUseBow="false">
                <!-- TODO: Drop arrow? -->
                <choiceState section="sect229" set="disabled" />
            </test>
        </section>

        <section id="sect13">
            <object objectId="dagger" />
            <object objectId="meal" index="0" />
            <object objectId="meal" index="1" />
            <object objectId="meal" index="2" />
            <object objectId="rope" />
            <object objectId="canteenwater" />
            <object objectId="torch" />
            <object objectId="tinderbox" />
            <object objectId="bow" />
            <object objectId="arrow" count="3" />
            <object objectId="blanket" />
            <object objectId="spear" />
        </section>

        <section id="sect14">
            <!-- (If your source of light is a Torch, remember to erase it from your Action Chart.) -->
            <test not="true" hasObject="lantern|firesphere">
                <drop objectId="torch" />
            </test>
            <choiceState section="sect345" set="disabled" />
            <test hasDiscipline="anmlctrl">
                <test expression="[KAILEVEL] >= 4">
                    <choiceState section="sect345" set="enabled" />
                    <choiceState section="sect32" set="disabled" />
                </test>
            </test>
        </section>

        <section id="sect15">
            <test canUseBow="false">
                <choiceState section="sect216" set="disabled" />
            </test>
        </section>

        <section id="sect16">
            <drop objectId="fireseed" />
            <endurance count="-2" />
        </section>

        <section id="sect18">
            <test not="true" hasDiscipline="dvnation">
                <choiceState section="sect143" set="disabled" />
            </test>
        </section>

        <section id="sect20">
            <death />
        </section>

        <section id="sect22">
            <pick class="arrow" count="-1" />
        </section>

        <section id="sect23">
            <test not="true" hasDiscipline="pthmnshp">
                <choiceState section="sect337" set="disabled" />
            </test>
        </section>

        <section id="sect24">
            <message id="msg-drop-weapon" 
                en-text="Drop a weapon before continue" 
                es-text="Deja un arma antes de continuar"
            />
            <choiceState section="all" set="disabled" />
            <onInventoryEvent>
                <test expression="[WEAPONLIKE-CNT-ON-ACTIONCHART] == 0 || [WEAPONLIKE-CNT-ON-SECTION] > 0">
                    <message id="msg-drop-weapon" op="hide" />
                    <choiceState section="all" set="enabled" />
                </test>
                <test not="true" expression="[WEAPONLIKE-CNT-ON-ACTIONCHART] == 0 || [WEAPONLIKE-CNT-ON-SECTION] > 0">
                    <message id="msg-drop-weapon" op="show" />
                    <choiceState section="all" set="disabled" />
                </test>
            </onInventoryEvent>
        </section>

        <section id="sect25">
            <drop objectId="vialbluepills|vialbluepills2" />
            <test not="true" hasDiscipline="dvnation">
                <choiceState section="sect298" set="disabled" />
            </test>
            <test hasDiscipline="dvnation">
                <choiceState section="sect41" set="disabled" />
            </test>
        </section>
        
        <section id="sect29">
            <object objectId="vialbluepills2" index="0" />
            <object objectId="vialbluepills2" index="1" />
        </section>
        
        <section id="sect32">
            <choiceState section="all" set="disabled" />
            <combat noMindblast="true" noPsiSurge="true" combatSkillModifier="-2" />
            <afterCombats>
                <choiceState section="all" set="enabled" />
            </afterCombats>
        </section>

        <section id="sect33">
            <!-- TODO: "If you have seen and examined one of these hexagonal tokens previously in your adventure" ??? 
                sect43, 
            -->
        </section>

        <section id="sect36">
            <choiceState section="all" set="disabled" />
            <combat eludeTurn="0" />
            <afterCombats>
                <choiceState section="sect170" set="enabled" />
            </afterCombats>
            <afterElude>
                <choiceState section="sect328" set="enabled" />
            </afterElude>
        </section>

        <section id="sect38">
            <choiceState section="all" set="disabled" />
            <randomTable>
                <case from="0" to="4">
                    <choiceState section="sect317" set="enabled" />
                </case>
                <case from="5" to="99">
                    <choiceState section="sect138" set="enabled" />
                </case>
            </randomTable>
            <test hasDiscipline="dvnation|hntmstry">
                <randomTableIncrement increment="+3" />
            </test>
        </section>

        <section id="sect40">
            <choiceState section="sect199" set="disabled" />
            <test hasDiscipline="dvnation">
                <test expression="[KAILEVEL] >= 4">
                    <choiceState section="sect199" set="enabled" />
                </test>
            </test>
        </section>

        <section id="sect44">
            <death />
        </section>

        <section id="sect46">
            <choiceState section="all" set="disabled" />
            <combat noMindblast="true" immuneTurns="2" />
            <afterCombats>
                <choiceState section="all" set="enabled" />
            </afterCombats>
        </section>

        <section id="sect47">
            <endurance count="-2" />
        </section>

        <section id="sect48">
            <endurance count="-5" />
        </section>

        <section id="sect50">
            <!-- TODO: This is the correct answer to Khmarâ€™s riddle about his youngest son -->
        </section>

        <section id="sect51">
            <test not="true" hasDiscipline="nexus">
                <choiceState section="sect118" set="disabled" />
            </test>
            <test hasDiscipline="nexus">
                <choiceState section="sect291" set="disabled" />
            </test>
        </section>

        <section id="sect52">
            <test not="true" hasDiscipline="pthmnshp">
                <choiceState section="sect96" set="disabled" />
            </test>
        </section>

        <section id="sect54">
            <!-- TODO: Where is lost the inventory -->
            <!--restoreInventoryState restorePoint="book8nventoryLost" /-->
        </section>

        <section id="sect56">
            <choiceState section="sect144" set="disabled" />
            <test hasDiscipline="invsblty">
                <test expression="[KAILEVEL] >= 6">
                    <choiceState section="sect144" set="enabled" />
                    <choiceState section="sect349" set="disabled" />
                </test>
            </test>
        </section>

        <section id="sect58">
            <object objectId="rope" />
            <object objectId="shortsword" />
            <object objectId="blanket" />
            <object objectId="mace" />
            <object objectId="bow" />
            <object objectId="canteenwater" />
            <object objectId="arrow" count="6" />
            <object objectId="quiver" />
            <object objectId="broadsword" />
            <object objectId="lantern" />
            <object objectId="dagger" />
        </section>

        <section id="sect59">
            <endurance count="-2" />
        </section>

        <section id="sect61">
            <test not="true" hasDiscipline="psiscrn">
                <endurance count="-3" />
            </test>
            <test hasDiscipline="psiscrn">
                <test not="true" expression="[KAILEVEL] >= 5">
                    <endurance count="-3" />
                </test>
            </test>
        </section>

        <section id="sect63">
            <meal />
        </section>

        <section id="sect64">
            <endurance count="-5" />
        </section>

        <section id="sect67">
            <choiceState section="sect16" set="disabled" />
            <choiceState section="sect214" set="disabled" />
            <test hasObject="fireseed">
                <choiceState section="sect16" set="enabled" />
                <choiceState section="sect277" set="disabled" />
            </test>
            <!-- TODO: psychicring? -->
            <!--test hasObject="psychicring">
                <choiceState section="sect214" set="enabled" />
                <choiceState section="sect277" set="disabled" />
            </test-->
        </section>

        <section id="sect72">
            <choiceState section="all" set="disabled" />
            <randomTable zeroAsTen="true">
                <endurance count=" -( [RANDOM] + 2 ) " />
                <choiceState section="all" set="enabled" />
            </randomTable>
        </section>

        <section id="sect73">
            <death />
        </section>

        <section id="sect75">
            <endurance count="+3" />
        </section>

        <section id="sect78">
            <test not="true" hasDiscipline="anmlctrl">
                <choiceState section="sect167" set="disabled" />
            </test>
            <test hasDiscipline="anmlctrl">
                <choiceState section="sect290" set="disabled" />
            </test>
        </section>
        
        <section id="sect82">
            <choiceState section="all" set="disabled" />

            <combat noMindblast="true" noPsiSurge="true" enemyMultiplier="2" />
            <test not="true" hasDiscipline="hntmstry">
                <combat combatSkillModifier="-2" />
            </test>

            <afterCombatTurn turn="any">
                <test expression="[COMBATSDURATION] >= 4">
                    <test combatsWon="false">
                        <disableCombats />
                        <choiceState section="sect151" set="enabled" />
                    </test>
                </test>
            </afterCombatTurn>
            <afterCombats>
                <test combatsWon="true">
                    <choiceState section="sect247" set="enabled" />
                </test>
            </afterCombats>
        </section>

        <!-- Up to sect84 -->

    </sections>

</mechanics>
